<h1>New Product</h1>
<%= form_with(model: @product, local: true, html: { id: 'product-form' }) do |form| %>
  <% if @product.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@product.errors.count, "error") %> prohibited this product from being saved:</h2>
      <ul>
        <% @product.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div class="field">
    <%= form.label :name %>
    <%= form.text_field :name %>
  </div>
  <div class="field">
    <%= form.label :description %>
    <%= form.text_area :description %>
  </div>
  <div class="field">
    <%= form.label :category_id %>
    <%= form.collection_select :category_id, Category.all, :id, :name, prompt: "Select a category" %>
  </div>
  <div class="field">
    <%= form.label :supplier_id %>
    <%= form.collection_select :supplier_id, Supplier.all, :id, :name, prompt: "Select a supplier" %>
  </div>
  <% if @product.product_variants.empty? %>
    <div class="field">
      <%= form.label :price, "Price" %>
      <%= form.number_field :price, step: 0.01, min: 0 %>
    </div>
    <div class="field">
      <%= form.label :stock_quantity, "Stock Quantity" %>
      <%= form.number_field :stock_quantity, min: 0 %>
    </div>
  <% else %>
    <h3>Variants</h3>
    <div class="field">
      <%= label_tag :sizes %>
      <%= text_field_tag :sizes, nil, placeholder: "e.g. S, M, L" %>
    </div>
    <div class="field">
      <%= label_tag :colors %>
      <%= text_field_tag :colors, nil, placeholder: "e.g. Red, Blue, Green" %>
    </div>
    <div class="field">
      <%= label_tag :materials %>
      <%= text_field_tag :materials, nil, placeholder: "e.g. Cotton, Polyester" %>
    </div>
    <button type="button" id="generate-variants">Generate Variants</button>
    <div id="variants-review" style="display: none;">
      <h3>Review Variants</h3>
      <table id="variants-table">
        <thead>
          <tr>
            <th>Size</th>
            <th>Color</th>
            <th>Material</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  <% end %>
  <div class="actions">
    <%= form.submit 'Create Product' %>
  </div>
<% end %>
<%= link_to 'Back', products_path %>
<script>
  const generateVariantsBtn = document.getElementById('generate-variants');
  const variantsReview = document.getElementById('variants-review');
  const variantsTable = document.getElementById('variants-table').getElementsByTagName('tbody')[0];
  const productForm = document.getElementById('product-form');

  generateVariantsBtn.addEventListener('click', function() {
    const sizes = document.getElementById('sizes').value.split(',').map(s => s.trim());
    const colors = document.getElementById('colors').value.split(',').map(c => c.trim());
    const materials = document.getElementById('materials').value.split(',').map(m => m.trim());

    variantsTable.innerHTML = '';
    // console.log(sizes, colors, materials)

    for (let size of sizes) {
      for (let color of colors) {
        for (let material of materials) {
          const row = variantsTable.insertRow();
          row.innerHTML = `
            <td>${size}</td>
            <td>${color}</td>
            <td>${material}</td>
            <td><input type="number" step="0.01" min="0" class="variant-price"></td>
            <td><input type="number" min="0" class="variant-stock"></td>
            <td><button type="button" class="remove-variant">Remove</button></td>
          `;
        }
      }
    }

    variantsReview.style.display = 'block';
  });

  variantsTable.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-variant')) {
      e.target.closest('tr').remove();
    }
  });

  productForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const variantRows = variantsTable.getElementsByTagName('tr');
    const variants = [];

    for (let row of variantRows) {
      const cells = row.getElementsByTagName('td');
      variants.push({
        size: cells[0].textContent,
        color: cells[1].textContent,
        material: cells[2].textContent,
        price: cells[3].getElementsByTagName('input')[0].value,
        stock_quantity: cells[4].getElementsByTagName('input')[0].value
      });
    }

    const variantsInput = document.createElement('input');
    variantsInput.type = 'hidden';
    variantsInput.name = 'variants';
    variantsInput.value = JSON.stringify(variants);
    productForm.appendChild(variantsInput);

    productForm.submit();
  });
</script>
